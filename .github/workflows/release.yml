name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    paths-ignore:
      - '**/*.md'
      - '.gitignore'

concurrency:
  group: release-${{ github.sha }}
  cancel-in-progress: false

jobs:
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Authenticate NuGet
        run: |
          dotnet nuget update source tm-packages \
            --username az \
            --password ${{ secrets.AZURE_DEVOPS_PAT }} \
            --store-password-in-clear-text \
            --configfile nuget.config

      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: ${{ runner.os }}-nuget-

      - name: Build
        run: dotnet build ses-local.sln -c Release

      - name: Test
        run: dotnet test ses-local.sln -c Release --no-build --verbosity normal

  publish:
    name: Publish ${{ matrix.rid }}
    needs: build-and-test
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      matrix:
        include:
          - rid: osx-arm64
            os: macos-latest
          - rid: win-x64
            os: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Authenticate NuGet
        shell: bash
        run: |
          dotnet nuget update source tm-packages \
            --username az \
            --password ${{ secrets.AZURE_DEVOPS_PAT }} \
            --store-password-in-clear-text \
            --configfile nuget.config

      - name: Publish Daemon
        shell: bash
        run: |
          dotnet publish src/Ses.Local.Daemon/Ses.Local.Daemon.csproj \
            --configuration Release \
            --runtime ${{ matrix.rid }} \
            -p:PublishSingleFile=true \
            -p:SelfContained=true \
            --output ./publish-daemon/${{ matrix.rid }}

      - name: Publish Tray
        shell: bash
        run: |
          dotnet publish src/Ses.Local.Tray/Ses.Local.Tray.csproj \
            --configuration Release \
            --runtime ${{ matrix.rid }} \
            -p:PublishSingleFile=true \
            -p:SelfContained=true \
            --output ./publish-tray/${{ matrix.rid }}

      - name: Rename binaries (macOS)
        if: startsWith(matrix.rid, 'osx-')
        shell: bash
        run: |
          mv ./publish-daemon/${{ matrix.rid }}/ses-local-daemon ./publish-daemon/${{ matrix.rid }}/ses-local-daemon
          mv ./publish-tray/${{ matrix.rid }}/Ses.Local.Tray ./publish-tray/${{ matrix.rid }}/ses-local

      - name: Rename binaries (Windows)
        if: matrix.rid == 'win-x64'
        shell: bash
        run: |
          mv ./publish-daemon/${{ matrix.rid }}/ses-local-daemon.exe ./publish-daemon/${{ matrix.rid }}/ses-local-daemon.exe
          mv ./publish-tray/${{ matrix.rid }}/Ses.Local.Tray.exe ./publish-tray/${{ matrix.rid }}/ses-local.exe

      - name: Package DMG (macOS only)
        if: startsWith(matrix.rid, 'osx-')
        shell: bash
        run: |
          DAEMON="./publish-daemon/${{ matrix.rid }}/ses-local-daemon"
          TRAY="./publish-tray/${{ matrix.rid }}/ses-local"
          chmod +x "$DAEMON" "$TRAY"

          # Build .app bundle with both binaries
          APP="./ses-local-installer.app"
          mkdir -p "$APP/Contents/MacOS"
          cp "$DAEMON" "$APP/Contents/MacOS/ses-local-daemon"
          cp "$TRAY" "$APP/Contents/MacOS/ses-local-installer"

          printf '%s\n' \
            '<?xml version="1.0" encoding="UTF-8"?>' \
            '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' \
            '<plist version="1.0"><dict>' \
            '  <key>CFBundleExecutable</key><string>ses-local-installer</string>' \
            '  <key>CFBundleIdentifier</key><string>com.supereasysoftware.ses-local-installer</string>' \
            '  <key>CFBundleName</key><string>ses-local Installer</string>' \
            '  <key>CFBundlePackageType</key><string>APPL</string>' \
            '  <key>CFBundleShortVersionString</key><string>1.0</string>' \
            '  <key>LSMinimumSystemVersion</key><string>13.0</string>' \
            '  <key>LSUIElement</key><true/>' \
            '</dict></plist>' \
            > "$APP/Contents/Info.plist"

          # Free up disk space before creating DMG
          rm -rf "./publish-daemon/${{ matrix.rid }}" "./publish-tray/${{ matrix.rid }}"

          hdiutil create \
            -volname "ses-local Installer" \
            -srcfolder "$APP" \
            -ov -format UDZO \
            "./ses-local-installer.dmg"

      - name: Upload artifact (Windows)
        if: matrix.rid == 'win-x64'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}
          path: |
            ./publish-daemon/${{ matrix.rid }}/ses-local-daemon.exe
            ./publish-tray/${{ matrix.rid }}/ses-local.exe
          if-no-files-found: error

      - name: Upload DMG artifact (macOS only)
        if: startsWith(matrix.rid, 'osx-')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.rid }}-dmg
          path: ./ses-local-installer.dmg
          if-no-files-found: error

  upload-blob:
    name: Upload to Blob + Write Manifest
    needs: publish
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Set version
        id: version
        run: |
          VERSION="$(date -u +%Y.%m.%d).${GITHUB_SHA:0:7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Upload binaries
        run: |
          V="${{ steps.version.outputs.version }}"

          az storage blob upload \
            --connection-string "${{ secrets.BLOB_CONNECTION_STRING }}" \
            --container-name artifacts \
            --name "ses-local/$V/ses-local-osx-arm64.dmg" \
            --file ./artifacts/osx-arm64-dmg/ses-local-installer.dmg \
            --overwrite
          az storage blob upload \
            --connection-string "${{ secrets.BLOB_CONNECTION_STRING }}" \
            --container-name artifacts \
            --name "ses-local/$V/ses-local-daemon-win-x64.exe" \
            --file ./artifacts/win-x64/ses-local-daemon.exe \
            --overwrite
          az storage blob upload \
            --connection-string "${{ secrets.BLOB_CONNECTION_STRING }}" \
            --container-name artifacts \
            --name "ses-local/$V/ses-local-win-x64.exe" \
            --file ./artifacts/win-x64/ses-local.exe \
            --overwrite

      - name: Write latest.json
        run: |
          V="${{ steps.version.outputs.version }}"
          BASE="https://downloads.supereasysoftware.com/artifacts/ses-local"
          cat > latest.json << EOF
          {
            "version": "$V",
            "published": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "binaries": {
              "osx-arm64": "$BASE/$V/ses-local-osx-arm64.dmg",
              "win-x64-daemon": "$BASE/$V/ses-local-daemon-win-x64.exe",
              "win-x64-tray":   "$BASE/$V/ses-local-win-x64.exe"
            }
          }
          EOF
          az storage blob upload \
            --connection-string "${{ secrets.BLOB_CONNECTION_STRING }}" \
            --container-name artifacts \
            --name "ses-local/latest.json" \
            --file ./latest.json \
            --overwrite
          echo "Published:"
          cat latest.json

  github-release:
    name: GitHub Release
    needs: publish
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.GH_APP_ID }}
          private_key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Stage binaries
        run: |
          cp ./artifacts/osx-arm64-dmg/ses-local-installer.dmg ./ses-local-osx-arm64.dmg
          cp ./artifacts/win-x64/ses-local-daemon.exe ./ses-local-daemon-win-x64.exe
          cp ./artifacts/win-x64/ses-local.exe ./ses-local-win-x64.exe

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          token: ${{ steps.app-token.outputs.token }}
          tag_name: "build-${{ github.sha }}"
          name: "Build ${{ github.sha }}"
          generate_release_notes: true
          prerelease: true
          files: |
            ses-local-osx-arm64.dmg
            ses-local-daemon-win-x64.exe
            ses-local-win-x64.exe
